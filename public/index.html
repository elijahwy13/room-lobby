<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basketball Wizard</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; display: grid; place-items: center; min-height: 100svh; background: #0f172a; color: #e2e8f0; }
    .container { width: min(900px, 94vw); display: grid; gap: 16px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    h1 { margin: 0 0 8px; font-size: 26px; display:flex; align-items:center; gap:10px; }
    .icon { width: 26px; height: 26px; display:inline-block; }
    .muted { color: #94a3b8; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    input { flex: 1; min-width: 140px; padding: 10px 12px; border-radius: 10px; border: 1px solid #334155; background: #0b1220; color: #e2e8f0; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #334155; background: #1e293b; color: #e2e8f0; cursor: pointer; }
    button:hover { filter: brightness(1.1); }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #0b1220; border: 1px solid #334155; font-weight: 600; letter-spacing: .08em; }
    .list { margin-top: 12px; border-top: 1px dashed #334155; padding-top: 12px; }
    .player { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
    .host { font-size: 12px; color: #93c5fd; border: 1px solid #93c5fd55; padding: 2px 6px; border-radius: 999px; }
    .error { color: #fca5a5; margin-top: 8px; min-height: 1.25em; }
    .start { margin-top: 12px; }

    /* Leaderboard styles */
    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #253043; }
    th { color: #9fb3d1; font-weight: 600; }
    tr:hover td { background: #0b1220; }
    .money-pos { color: #34d399; } /* green */
    .money-neg { color: #f87171; } /* red */
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <!-- Lobby card -->
    <div class="card">
      <h1>
        <!-- Wand -->
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="#e2e8f0" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 3l-2 2m6 2l-2 2M9 3l1 3M21 9l-3-1M13 11L4.5 19.5a2.121 2.121 0 0 1-3-3L10 8" />
          <rect x="11.5" y="6.5" width="3" height="3" transform="rotate(45 13 8)" />
        </svg>
        Basketball Wizard
        <!-- Ball -->
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="#e2e8f0" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="9" />
          <path d="M3 12h18M12 3v18" />
          <path d="M5.5 5.5c4 4 8 4 13 13M18.5 5.5c-4 4-8 4-13 13" />
        </svg>
      </h1>

      <div id="prejoin">
        <div class="row" style="margin-bottom:8px;">
          <input id="name" placeholder="Display name" autocomplete="name" />
        </div>
        <div class="row" style="margin-bottom:8px;">
          <input id="code" placeholder="Room code (e.g., ABCD)" maxlength="4" style="text-transform:uppercase;" />
        </div>
        <div class="row">
          <!-- Join on the LEFT, Create on the RIGHT -->
          <button id="joinBtn">Join</button>
          <button id="createBtn">Create New Room</button>
        </div>
        <div class="error" id="err"></div>
      </div>

      <div id="lobby" style="display:none;">
        <div>Room Code: <span class="pill" id="roomCode">----</span></div>
        <div class="list" id="playerList"></div>
        <div class="start">
          <button id="startBtn" title="Host only">Start Game</button>
        </div>
        <div class="muted" style="margin-top:10px;">Share the code with friends. When everyone joins, the host can start.</div>
      </div>
    </div>

    <!-- Leaderboard card -->
    <div class="card">
      <h2 style="margin:0 0 12px; font-size:20px;">FanDuel Leaderboard</h2>
      <div class="table-wrap">
        <table id="leaderboard">
          <thead>
            <tr>
              <th>Player</th>
              <th>Wins</th>
              <th>Money Won</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <!-- populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const $ = (id) => document.getElementById(id);
      const socket = io({ transports: ['websocket','polling'], path: '/socket.io' });

      let you = null;
      let currentCode = null;
      window.currentCode = null;

      function setError(msg='') { $('err').textContent = msg; }
      function showLobby(code) {
        currentCode = code;
        window.currentCode = code;
        $('roomCode').textContent = code;
        $('prejoin').style.display = 'none';
        $('lobby').style.display = '';
        $('startBtn').style.display = you?.isHost ? '' : 'none';
      }
      function renderPlayers(players) {
        const list = $('playerList');
        list.innerHTML = '';
        players.forEach(p => {
          const row = document.createElement('div');
          row.className = 'player';
          row.innerHTML = `<div>ðŸ‘¤</div><div>${p.name}</div>${p.isHost ? '<div class="host">HOST</div>' : ''}`;
          list.appendChild(row);
        });
      }

      // Create room
      $('createBtn').onclick = async () => {
        try {
          setError('');
          const name = $('name').value.trim();
          if (!name) return setError('Enter a display name');

          const res = await fetch('/api/rooms', { method: 'POST' });
          if (!res.ok) throw new Error('Failed to create room');
          const { code } = await res.json();

          socket.emit('room:join', { code, name, host: true }, (resp) => {
            if (!resp?.ok) return setError(resp?.error || 'Join failed');
            you = resp.you;
            showLobby(code);
          });
        } catch (e) {
          console.error(e);
          setError('Could not create room.');
        }
      };

      // Join room
      $('joinBtn').onclick = () => {
        setError('');
        const name = $('name').value.trim();
        const code = $('code').value.trim().toUpperCase();
        if (!name) return setError('Enter a display name');
        if (code.length !== 4) return setError('Room code must be 4 letters');

        socket.emit('room:join', { code, name }, (resp) => {
          if (!resp?.ok) return setError(resp?.error || 'Join failed');
          you = resp.you;
          showLobby(code);
        });
      };

      $('startBtn').onclick = () => socket.emit('room:start');

      socket.on('room:update', ({ code, players }) => {
        if (currentCode && code !== currentCode) return;
        renderPlayers(players);
      });

      socket.on('room:started', () => {
        const meta = { code: currentCode, name: you?.name || 'Player', isHost: !!you?.isHost };
        try { sessionStorage.setItem('roomMeta', JSON.stringify(meta)); } catch {}
        window.location.href = '/game.html';
      });

      socket.on('connect_error', (e) => {
        console.error('Socket connect error:', e);
        setError('Connection error. Is the server running?');
      });

      // Invite auto-fill
      const pre = new URLSearchParams(location.search).get('code');
      if (pre) { const el = $('code'); if (el) el.value = pre.toUpperCase(); }

      // ---- Leaderboard fetch & render ----
      async function loadLeaderboard() {
        try {
          const res = await fetch('/api/standings');
          const data = await res.json();
          const rows = (data.standings || []).map(({ name, wins, money }) => {
            const tr = document.createElement('tr');
            const tdName = document.createElement('td');
            const tdWins = document.createElement('td');
            const tdMoney = document.createElement('td');
            tdName.textContent = name;
            tdWins.textContent = String(wins ?? 0);
            const val = Number(money ?? 0);
            tdMoney.textContent = (val < 0 ? '-$' + Math.abs(val).toFixed(2) : '$' + val.toFixed(2));
            tdMoney.className = val < 0 ? 'money-neg' : (val > 0 ? 'money-pos' : '');
            tr.appendChild(tdName); tr.appendChild(tdWins); tr.appendChild(tdMoney);
            return tr;
          });

          const body = $('leaderboardBody');
          body.innerHTML = '';
          rows.forEach(r => body.appendChild(r));
        } catch (e) {
          console.error('Failed to load leaderboard', e);
          $('lbNote').textContent = 'Could not load leaderboard.';
        }
      }
      loadLeaderboard();
    });
  </script>
</body>
</html>
