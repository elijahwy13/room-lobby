<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room Lobby</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; display: grid; place-items: center; min-height: 100svh; background: #0f172a; color: #e2e8f0; }
    .card { width: min(680px, 92vw); background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .muted { color: #94a3b8; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    input { flex: 1; min-width: 140px; padding: 10px 12px; border-radius: 10px; border: 1px solid #334155; background: #0b1220; color: #e2e8f0; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #334155; background: #1e293b; color: #e2e8f0; cursor: pointer; }
    button:hover { filter: brightness(1.1); }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #0b1220; border: 1px solid #334155; font-weight: 600; letter-spacing: .08em; }
    .list { margin-top: 12px; border-top: 1px dashed #334155; padding-top: 12px; }
    .player { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
    .host { font-size: 12px; color: #93c5fd; border: 1px solid #93c5fd55; padding: 2px 6px; border-radius: 999px; }
    .error { color: #fca5a5; margin-top: 8px; min-height: 1.25em; }
    .start { margin-top: 12px; }
  </style>
  <!-- Use the server-served Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="card">
    <h1>Party Lobby</h1>
    <div class="muted">Create a room and share the code, or join one. Works in Safari.</div>

    <div id="prejoin">
      <div class="row" style="margin-bottom:8px;">
        <input id="name" placeholder="Display name" autocomplete="name" />
      </div>
      <div class="row" style="margin-bottom:8px;">
        <input id="code" placeholder="Room code (e.g., ABCD)" maxlength="4" style="text-transform:uppercase;" />
        <button id="joinBtn">Join</button>
      </div>
      <div class="row">
        <button id="createBtn">Create New Room</button>
      </div>
      <div class="error" id="err"></div>
    </div>

    <div id="lobby" style="display:none;">
      <div>Room Code: <span class="pill" id="roomCode">----</span></div>
      <div class="list" id="playerList"></div>
      <div class="start">
        <button id="startBtn" title="Host only">Start Game</button>
      </div>
      <div class="muted" style="margin-top:10px;">Share the code with friends. When everyone joins, the host can start.</div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const $ = (id) => document.getElementById(id);
      const socket = io();

      let you = null; // { id, name, isHost }
      let currentCode = null;

      function setError(msg='') { $('err').textContent = msg; }
      function showLobby(code) {
        currentCode = code;
        $('roomCode').textContent = code;
        $('prejoin').style.display = 'none';
        $('lobby').style.display = '';
        $('startBtn').style.display = you?.isHost ? '' : 'none';
      }
      function renderPlayers(players) {
        const list = $('playerList');
        list.innerHTML = '';
        players.forEach(p => {
          const row = document.createElement('div');
          row.className = 'player';
          row.innerHTML = `<div>ðŸ‘¤</div><div>${p.name}</div>${p.isHost ? '<div class="host">HOST</div>' : ''}`;
          list.appendChild(row);
        });
      }

      $('createBtn').onclick = async () => {
        try {
          setError('');
          const name = $('name').value.trim();
          if (!name) return setError('Enter a display name');

          const res = await fetch('/api/rooms', { method: 'POST' });
          if (!res.ok) throw new Error('Failed to create room');
          const { code } = await res.json();

          socket.emit('room:join', { code, name, host: true }, (resp) => {
            if (!resp?.ok) return setError(resp?.error || 'Join failed');
            you = resp.you;
            showLobby(code);
          });
        } catch (e) {
          console.error(e);
          setError('Could not create room.');
        }
      };

      $('joinBtn').onclick = () => {
        setError('');
        const name = $('name').value.trim();
        const code = $('code').value.trim().toUpperCase();
        if (!name) return setError('Enter a display name');
        if (code.length !== 4) return setError('Room code must be 4 letters');

        socket.emit('room:join', { code, name }, (resp) => {
          if (!resp?.ok) return setError(resp?.error || 'Join failed');
          you = resp.you;
          showLobby(code);
        });
      };

      $('startBtn').onclick = () => {
        socket.emit('room:start');
      };

      socket.on('room:update', ({ code, players }) => {
        if (currentCode && code !== currentCode) return;
        renderPlayers(players);
      });

      socket.on('room:started', () => {
        const meta = { code: currentCode, name: you?.name || 'Player', isHost: !!you?.isHost };
        try { sessionStorage.setItem('roomMeta', JSON.stringify(meta)); } catch {}
        window.location.href = '/game.html';
      });


      // Helpful connection logs
      socket.on('connect', () => console.log('Socket connected:', socket.id));
      socket.on('connect_error', (e) => {
        console.error('Socket connect error:', e);
        setError('Connection error. Is the server running?');
      });
    });
  </script>
</body>
</html>
